# ProgRAG çŸ¥è¯†å›¾è°±æ¨ç†æœºåˆ¶è¯¦è§£

## ğŸ“š çŸ¥è¯†å›¾è°±æ•°æ®æ¥æº

### 1. æ•°æ®é›†åŸºç¡€

**ProgRAG ä½¿ç”¨çš„æ˜¯å·²æœ‰çš„çŸ¥è¯†å›¾è°±æ•°æ®**ï¼Œæ¥æºæ˜¯ Hugging Face ä¸Šçš„ RoG (Reasoning over Graph) æ•°æ®é›†ï¼š

- **WebQSP**: `rmanluo/RoG-webqsp`
- **CWQ**: `rmanluo/RoG-cwq` (Complex Web Questions)

è¿™äº›æ•°æ®é›†å·²ç»åŒ…å«äº†å®Œæ•´çš„çŸ¥è¯†å›¾è°±ï¼Œ**ä¸æ˜¯è¿è¡Œæ—¶æ„å»ºçš„**ï¼Œè€Œæ˜¯åŸºäº Freebase ç­‰å¤§å‹çŸ¥è¯†åº“é¢„å¤„ç†å¾—åˆ°çš„ã€‚

### 2. çŸ¥è¯†å›¾è°±æ ¼å¼

çŸ¥è¯†å›¾è°±ä»¥**ä¸‰å…ƒç»„ï¼ˆTripleï¼‰**çš„å½¢å¼å­˜å‚¨ï¼š

```
(å¤´å®ä½“, å…³ç³», å°¾å®ä½“)
```

**ç¤ºä¾‹ä¸‰å…ƒç»„**ï¼š
```
("Jerry Jones", "sports.sports_team_owner.teams_owned", "Dallas Cowboys")
("Dallas Cowboys", "sports.sports_team_roster.player", "Tony Romo")
("Tony Romo", "people.person.profession", "American Football Player")
```

### 3. æ•°æ®ç»“æ„

#### æ€»å›¾è°±ï¼ˆTotal Graphï¼‰
- **ä½ç½®**: `/data/graphs/total_graph_{dataset}.jsonl`
- **å†…å®¹**: æ‰€æœ‰è®­ç»ƒ/éªŒè¯/æµ‹è¯•é›†ä¸­çš„ä¸‰å…ƒç»„é›†åˆ
- **æ ¼å¼**: JSON Linesï¼Œæ¯è¡Œæ˜¯ä¸€ä¸ªä¸‰å…ƒç»„åˆ—è¡¨

#### ä¸»é¢˜å®ä½“å­å›¾ï¼ˆTopic Graphï¼‰
- **ä½ç½®**: `/data/graphs/{dataset}_topic_graph.pickle`
- **å†…å®¹**: æ¯ä¸ªä¸»é¢˜å®ä½“å¯¹åº”çš„ç›¸å…³å­å›¾ï¼ˆä¸‰å…ƒç»„IDåˆ—è¡¨ï¼‰
- **ç”¨é€”**: å¿«é€Ÿå®šä½ä¸æŸä¸ªå®ä½“ç›¸å…³çš„æ‰€æœ‰ä¸‰å…ƒç»„

#### ä¸‰å…ƒç»„æ˜ å°„ï¼ˆTriple2IDï¼‰
- **ä½ç½®**: `/data/graphs/{dataset}_triple2id.pkl`
- **å†…å®¹**: ä¸‰å…ƒç»„åˆ°IDçš„æ˜ å°„ï¼Œç”¨äºæé«˜å­˜å‚¨å’Œè®¡ç®—æ•ˆç‡
- **æ ¼å¼**: 
  ```python
  {("Jerry Jones", "sports.sports_team_owner.teams_owned", "Dallas Cowboys"): 12345}
  ```

---

## ğŸ”„ æ¨ç†æµç¨‹è¯¦è§£

### é˜¶æ®µ 1: æ•°æ®åŠ è½½

```python
# ä» Hugging Face åŠ è½½é—®é¢˜æ•°æ®é›†
dataset = load_dataset("rmanluo/RoG-webqsp", split="test")

# åŠ è½½æ€»å›¾è°±
with open('/data/graphs/total_graph_webqsp.jsonl', 'r') as f:
    graph = json.load(f.readline())  # æ‰€æœ‰ä¸‰å…ƒç»„

# åŠ è½½ä¸»é¢˜å®ä½“å­å›¾æ˜ å°„
with open('/data/graphs/webqsp_topic_graph.pickle', 'rb') as f:
    topic_graphs = pickle.load(f)  # {å®ä½“: [ä¸‰å…ƒç»„IDåˆ—è¡¨]}
```

### é˜¶æ®µ 2: é—®é¢˜åˆ†è§£

**è¾“å…¥é—®é¢˜**: "Who was the 1996 coach of the team owned by Jerry Jones?"

**LLM åˆ†è§£**:
1. è¯†åˆ«ä¸»é¢˜å®ä½“: `["Jerry Jones"]`
2. åˆ†è§£ä¸ºå­é—®é¢˜:
   - å­é—®é¢˜1: "What sports team's owners are Jerry Jones?"
   - å­é—®é¢˜2: "Who was the 1996 coach of that team?"

### é˜¶æ®µ 3: æ¸è¿›å¼æ£€ç´¢ä¸æ¨ç†

è¿™æ˜¯ä¸€ä¸ª**è¿­ä»£çš„è¿‡ç¨‹**ï¼Œæ¯ä¸€æ­¥éƒ½ä»å½“å‰å®ä½“å‡ºå‘ï¼š

#### æ­¥éª¤ 1: å…³ç³»æ£€ç´¢ï¼ˆRelation Retrievalï¼‰

ä»ä¸»é¢˜å®ä½“ `Jerry Jones` å‡ºå‘ï¼Œæ£€ç´¢æ‰€æœ‰å¯èƒ½çš„å…³ç³»ï¼š

```
å€™é€‰å…³ç³»:
- sports.sports_team_owner.teams_owned
- people.person.nationality
- people.person.spouse_s
- sports.professional_sports_team.owner_s
...
```

**Relation Retrieverï¼ˆCrossEncoderï¼‰** å¯¹æ¯ä¸ªå…³ç³»è¯„åˆ†ï¼š
```python
score = model.rank(question, "Jerry Jones, sports.sports_team_owner.teams_owned, Dallas Cowboys")
```

**LLM è¿›ä¸€æ­¥ç­›é€‰**ï¼Œé€‰æ‹© Top-3 æœ€ç›¸å…³å…³ç³»ï¼š
```python
retrieved_rel = ["sports.sports_team_owner.teams_owned", 
                 "sports.professional_sports_team.owner_s"]
```

#### æ­¥éª¤ 2: ä¸‰å…ƒç»„æ£€ç´¢ï¼ˆTriple Retrievalï¼‰

åŸºäºæ£€ç´¢åˆ°çš„å…³ç³»ï¼Œæ‰¾åˆ°æ‰€æœ‰ç›¸å…³çš„ä¸‰å…ƒç»„ï¼š

```python
# ä»å›¾è°±ä¸­æ‰¾åˆ°æ‰€æœ‰ä»¥ Jerry Jones ä¸ºå¤´å®ä½“ã€å…³ç³»ä¸º sports.sports_team_owner.teams_owned çš„ä¸‰å…ƒç»„
cand_triples = [
    ("Jerry Jones", "sports.sports_team_owner.teams_owned", "Dallas Cowboys")
]
```

**æ„å»ºå€™é€‰è·¯å¾„**:
```
è·¯å¾„1: Jerry Jones -> sports.sports_team_owner.teams_owned -> Dallas Cowboys
```

#### æ­¥éª¤ 3: ä¸‰å…ƒç»„è¯„åˆ†ï¼ˆDual Scoringï¼‰

**GNN è¯„åˆ†**:
```python
# åŸºäºå›¾ç¥ç»ç½‘ç»œï¼Œä»å›¾ç»“æ„è§’åº¦è¯„åˆ†
gnn_scores = gnn_model(question, graph, target_entities)
# è¾“å‡º: {"Dallas Cowboys": 0.85}
```

**MPNet è¯„åˆ†**:
```python
# åŸºäºåŒç¼–ç å™¨ï¼Œä»è¯­ä¹‰ç›¸ä¼¼åº¦è§’åº¦è¯„åˆ†
mpnet_scores = mpnet_predictor(question, cand_triples)
# è¾“å‡º: {"Dallas Cowboys": 0.92}
```

**èåˆè¯„åˆ†**:
```python
final_scores = {
    "Dallas Cowboys": gnn_scores["Dallas Cowboys"] + mpnet_scores["Dallas Cowboys"]
    # = 0.85 + 0.92 = 1.77
}
```

#### æ­¥éª¤ 4: LLM éªŒè¯ä¸ç­›é€‰

å°†è¯„åˆ†åçš„å€™é€‰å®ä½“å’Œè·¯å¾„è¾“å…¥ LLMï¼š

```
é—®é¢˜: "What sports team's owners are Jerry Jones?"
å€™é€‰æ¨ç†è·¯å¾„:
- Jerry Jones -> sports.sports_team_owner.teams_owned -> Dallas Cowboys [Candidate entity: ["Dallas Cowboys"]]

LLM è¾“å‡º: ["Dallas Cowboys"]
```

#### æ­¥éª¤ 5: ç»§ç»­æ¨ç†ï¼ˆä¸‹ä¸€ä¸ªå­é—®é¢˜ï¼‰

å°†ç¬¬ä¸€ä¸ªå­é—®é¢˜çš„ç­”æ¡ˆ `["Dallas Cowboys"]` ä½œä¸ºæ–°çš„ä¸»é¢˜å®ä½“ï¼Œç»§ç»­ç¬¬äºŒä¸ªå­é—®é¢˜ï¼š

```
æ–°ä¸»é¢˜å®ä½“: "Dallas Cowboys"
æ–°é—®é¢˜: "Who was the 1996 coach of Dallas Cowboys?"

é‡å¤æ­¥éª¤ 1-4:
- å…³ç³»æ£€ç´¢: ["sports.sports_team_roster.coach", "sports.sports_team.coach"]
- ä¸‰å…ƒç»„æ£€ç´¢: ("Dallas Cowboys", "sports.sports_team_roster.coach", "Barry Switzer")
- è¯„åˆ†ä¸éªŒè¯
- æœ€ç»ˆç­”æ¡ˆ: ["Barry Switzer"]
```

### é˜¶æ®µ 4: è·¯å¾„æ•´åˆä¸æœ€ç»ˆç­”æ¡ˆ

å°†æ‰€æœ‰å­é—®é¢˜çš„æ¨ç†è·¯å¾„æ•´åˆï¼š

```
å®Œæ•´è·¯å¾„:
Jerry Jones -> sports.sports_team_owner.teams_owned -> Dallas Cowboys 
           -> sports.sports_team_roster.coach -> Barry Switzer
```

**GNN + MPNet æœ€ç»ˆè¯„åˆ†**æ‰€æœ‰å¯èƒ½çš„è·¯å¾„ï¼ŒLLM é€‰æ‹©æœ€åˆç†çš„ç­”æ¡ˆã€‚

---

## ğŸ¯ å®Œæ•´ç¤ºä¾‹

### ç¤ºä¾‹é—®é¢˜

**é—®é¢˜**: "Who was the 1996 coach of the team owned by Jerry Jones?"

**ä¸»é¢˜å®ä½“**: `["Jerry Jones"]`

### æ‰§è¡Œè¿‡ç¨‹

#### ç¬¬ 1 æ­¥ï¼šé—®é¢˜åˆ†è§£

```python
en_qu_dict = {
    "Jerry Jones": ["What sports team's owners are Jerry Jones?", 
                    "Who was the 1996 coach of that team?"]
}
```

#### ç¬¬ 2 æ­¥ï¼šå¤„ç†ç¬¬ä¸€ä¸ªå­é—®é¢˜

**å­é—®é¢˜1**: "What sports team's owners are Jerry Jones?"

1. **å…³ç³»æ£€ç´¢**:
   ```python
   # ä»å›¾è°±ä¸­æ‰¾åˆ° Jerry Jones çš„æ‰€æœ‰å‡ºè¾¹å…³ç³»
   cand_rel = ["sports.sports_team_owner.teams_owned", 
               "sports.professional_sports_team.owner_s",
               "people.person.nationality", ...]
   
   # CrossEncoder + LLM ç­›é€‰
   retrieved_rel = ["sports.sports_team_owner.teams_owned"]
   ```

2. **ä¸‰å…ƒç»„æ£€ç´¢**:
   ```python
   # ä» total_graph ä¸­æ‰¾åˆ°åŒ¹é…çš„ä¸‰å…ƒç»„
   cand_path = {
       "sports.sports_team_owner.teams_owned": [
           ("Jerry Jones", "sports.sports_team_owner.teams_owned", "Dallas Cowboys")
       ]
   }
   ```

3. **è¯„åˆ†**:
   ```python
   # GNN è¯„åˆ†
   gnn_entity2prob = {"Dallas Cowboys": 0.88}
   
   # MPNet è¯„åˆ†
   mpnet_entity2prob = {"Dallas Cowboys": 0.91}
   
   # èåˆ
   total_score = {"Dallas Cowboys": 1.79}
   ```

4. **LLM éªŒè¯**:
   ```python
   input_text = """
   Question: What sports team's owners are Jerry Jones?
   Candidate reasoning paths: 
   Jerry Jones sports.sports_team_owner.teams_owned Dallas Cowboys [Candidate entity: ["Dallas Cowboys"]]
   """
   
   llm_output = ["Dallas Cowboys"]
   ```

5. **æ›´æ–°è·¯å¾„**:
   ```python
   path_map = {
       "Dallas Cowboys": [
           ["Jerry Jones", "sports.sports_team_owner.teams_owned", "Dallas Cowboys"]
       ]
   }
   ```

#### ç¬¬ 3 æ­¥ï¼šå¤„ç†ç¬¬äºŒä¸ªå­é—®é¢˜

**å­é—®é¢˜2**: "Who was the 1996 coach of Dallas Cowboys?"

1. **æ–°çš„ä¸»é¢˜å®ä½“**: `["Dallas Cowboys"]`

2. **å…³ç³»æ£€ç´¢**:
   ```python
   cand_rel = ["sports.sports_team_roster.coach",
               "sports.sports_team.coach", ...]
   
   retrieved_rel = ["sports.sports_team_roster.coach"]
   ```

3. **ä¸‰å…ƒç»„æ£€ç´¢**:
   ```python
   cand_path = {
       "sports.sports_team_roster.coach": [
           ("Dallas Cowboys", "sports.sports_team_roster.coach", "Barry Switzer", "1996")
       ]
   }
   ```

4. **è¯„åˆ†ä¸éªŒè¯**:
   ```python
   final_answers = ["Barry Switzer"]
   ```

5. **è·¯å¾„æ›´æ–°**:
   ```python
   path_map = {
       "Barry Switzer": [
           ["Jerry Jones", "sports.sports_team_owner.teams_owned", "Dallas Cowboys",
            "sports.sports_team_roster.coach", "Barry Switzer"]
       ]
   }
   ```

#### ç¬¬ 4 æ­¥ï¼šæœ€ç»ˆæ•´åˆ

```python
# å¯¹æ‰€æœ‰è·¯å¾„è¿›è¡Œæœ€ç»ˆè¯„åˆ†
final_sorted_entities = ["Barry Switzer", ...]

# LLM æœ€ç»ˆéªŒè¯
final_answer = ["Barry Switzer"]
```

**æœ€ç»ˆç­”æ¡ˆ**: `["Barry Switzer"]`

**å®Œæ•´æ¨ç†è·¯å¾„**:
```
Jerry Jones 
  â†’ [sports.sports_team_owner.teams_owned] 
  â†’ Dallas Cowboys 
  â†’ [sports.sports_team_roster.coach] 
  â†’ Barry Switzer
```

---

## ğŸ”§ æ•°æ®å¤„ç†è¯¦è§£

### 1. å›¾è°±é¢„å¤„ç†

```python
# graph_preprocess.py çš„æ ¸å¿ƒæµç¨‹

def make_total_graph(dataset):
    # 1. ä» Hugging Face åŠ è½½æ•°æ®é›†
    train_dataset = load_dataset(f"rmanluo/RoG-{dataset}", split='train')
    valid_dataset = load_dataset(f"rmanluo/RoG-{dataset}", split='validation')
    test_dataset = load_dataset(f"rmanluo/RoG-{dataset}", split='test')
    
    # 2. æå–æ‰€æœ‰ä¸‰å…ƒç»„ï¼ˆå»é‡ï¼‰
    temp_set = set()
    for item in train_dataset + valid_dataset + test_dataset:
        for triple in item['graph']:  # item['graph'] åŒ…å«è¯¥é—®é¢˜çš„ç›¸å…³å­å›¾
            temp_set.add(tuple(triple))
    
    # 3. ä¿å­˜ä¸ºæ€»å›¾è°±
    with open(f'/data/graphs/total_graph_{dataset}.jsonl', 'w') as f:
        json.dump(list(temp_set), f)
```

### 2. ä¸»é¢˜å®ä½“å­å›¾æ„å»º

```python
def make_topic2graph(dataset):
    topic2graph = {}
    
    # å¯¹æ¯ä¸ªé—®é¢˜çš„ä¸»é¢˜å®ä½“ï¼Œæ”¶é›†ç›¸å…³å­å›¾
    for item in dataset:
        q_entities = item['q_entity']  # é—®é¢˜ä¸­çš„ä¸»é¢˜å®ä½“
        subgraph = item['graph']       # è¯¥é—®é¢˜çš„å­å›¾
        
        for entity in q_entities:
            if entity not in topic2graph:
                topic2graph[entity] = set()
            topic2graph[entity] |= set(subgraph)
    
    # è½¬æ¢ä¸ºä¸‰å…ƒç»„IDåˆ—è¡¨ï¼ˆèŠ‚çœç©ºé—´ï¼‰
    triple2id = load_triple2id()
    entity_graph_ids = {
        entity: [triple2id[triple] for triple in triples]
        for entity, triples in topic2graph.items()
    }
    
    # ä¿å­˜
    pickle.dump(entity_graph_ids, f)
```

### 3. å›¾è°±æ•°æ®ç»“æ„

**æ€»å›¾è°±ï¼ˆtotal_graphï¼‰**:
- åŒ…å«æ‰€æœ‰å¯èƒ½çš„ä¸‰å…ƒç»„
- ç”¨äºæ£€ç´¢å€™é€‰ä¸‰å…ƒç»„

**ä¸»é¢˜å®ä½“å­å›¾ï¼ˆtopic_graphï¼‰**:
- æ¯ä¸ªå®ä½“å¯¹åº”çš„ä¸‰å…ƒç»„IDåˆ—è¡¨
- ç”¨äºå¿«é€ŸåŠ è½½ä¸å®ä½“ç›¸å…³çš„å­å›¾ï¼Œå‡å°‘è®¡ç®—é‡

**å…³ç³»å›¾ï¼ˆrelation_graphï¼‰**:
```python
# åœ¨ utils.py ä¸­æ„å»º
relation_graph = {
    "Jerry Jones": {"sports.sports_team_owner.teams_owned", 
                    "people.person.nationality", ...},
    "Dallas Cowboys": {"sports.sports_team_roster.player", 
                      "sports.sports_team.coach", ...}
}
```

**å°¾å®ä½“å›¾ï¼ˆtail_graphï¼‰**:
```python
# ç”¨äºå¿«é€ŸæŸ¥æ‰¾: ç»™å®š (å¤´å®ä½“, å…³ç³»)ï¼Œæ‰¾æ‰€æœ‰å°¾å®ä½“
tail_graph = {
    ("Jerry Jones", "sports.sports_team_owner.teams_owned"): ["Dallas Cowboys"]
}
```

---

## ğŸ“ å…³é”®ç‰¹ç‚¹

### 1. **æ¸è¿›å¼æ¨ç†**
- ä¸æ˜¯ä¸€æ¬¡æ€§æ£€ç´¢æ‰€æœ‰å€™é€‰ï¼Œè€Œæ˜¯é€æ­¥æ‰©å±•
- æ¯ä¸€æ­¥éƒ½åŸºäºå‰ä¸€æ­¥çš„ç»“æœ

### 2. **å¤šæ¨¡å‹èåˆ**
- **CrossEncoder**: å…³ç³»æ£€ç´¢
- **GNN**: åŸºäºå›¾ç»“æ„çš„å®ä½“è¯„åˆ†
- **MPNet**: åŸºäºè¯­ä¹‰ç›¸ä¼¼åº¦çš„ä¸‰å…ƒç»„è¯„åˆ†
- **LLM**: é—®é¢˜åˆ†è§£å’Œç­”æ¡ˆéªŒè¯

### 3. **è·¯å¾„è¿½è¸ª**
- è®°å½•å®Œæ•´çš„æ¨ç†è·¯å¾„ï¼Œä¸ä»…ä»…æ˜¯ç­”æ¡ˆ
- æ”¯æŒå¤šè·³æ¨ç†ï¼ˆå¦‚ CWQ æ•°æ®é›†æœ€å¤š 3 è·³ï¼‰

### 4. **æŠ—å¹»è§‰æœºåˆ¶**
- å¤šæ­¥éª¤éªŒè¯
- è¯„åˆ†èåˆ
- LLM æœ€ç»ˆéªŒè¯

---

## ğŸ“Š æ•°æ®æµç¨‹æ€»ç»“

```
åŸå§‹æ•°æ® (Hugging Face)
    â†“
å›¾è°±æå–ä¸é¢„å¤„ç† (graph_preprocess.py)
    â†“
æ€»å›¾è°± + ä¸»é¢˜å®ä½“å­å›¾ (å­˜å‚¨åœ¨ /data/graphs/)
    â†“
è¿è¡Œæ—¶åŠ è½½ (get_dataset)
    â†“
é—®é¢˜è¾“å…¥ â†’ é—®é¢˜åˆ†è§£ â†’ å…³ç³»æ£€ç´¢ â†’ ä¸‰å…ƒç»„æ£€ç´¢ â†’ è¯„åˆ† â†’ è·¯å¾„æ„å»º
    â†“
æœ€ç»ˆç­”æ¡ˆ + æ¨ç†è·¯å¾„
```

---

## ğŸ” ä¸ä¼ ç»Ÿæ•°æ®åº“çš„åŒºåˆ«

**ProgRAG ä¸ä½¿ç”¨ä¼ ç»Ÿæ•°æ®åº“**ï¼ˆå¦‚ MySQLã€PostgreSQLï¼‰ï¼Œè€Œæ˜¯ï¼š

1. **åŸºäºæ–‡ä»¶å­˜å‚¨**: JSON Lines å’Œ Pickle æ ¼å¼
2. **å†…å­˜åŠ è½½**: å›¾è°±æ•°æ®åŠ è½½åˆ°å†…å­˜ä¸­è¿›è¡Œæ£€ç´¢
3. **é¢„è®¡ç®—ç´¢å¼•**: ä¸»é¢˜å®ä½“å­å›¾ã€å…³ç³»å›¾ç­‰ç´¢å¼•ç»“æ„
4. **å›¾ç»“æ„æŸ¥è¯¢**: é€šè¿‡å›¾éå†ï¼ˆDFSï¼‰å’Œå…³ç³»åŒ¹é…è¿›è¡Œæ£€ç´¢

è¿™ç§æ–¹å¼é€‚åˆ**åªè¯»**çš„çŸ¥è¯†å›¾è°±é—®ç­”åœºæ™¯ï¼ŒæŸ¥è¯¢é€Ÿåº¦å¿«ï¼Œä½†ä¸æ”¯æŒé¢‘ç¹æ›´æ–°ã€‚

